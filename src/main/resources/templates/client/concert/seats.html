<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="client/fragment/header :: header"></head>

<body>
<div class="container mt-4 mb-5">

    <div class="text-center mb-4">
        <h2 class="fw-bold">좌석 선택</h2>
        <p class="text-muted">원하시는 좌석을 선택해주세요.</p>
    </div>

    <div class="w-100 bg-dark text-white text-center py-2 mb-4 rounded shadow-sm" style="max-width: 600px; margin: 0 auto;">
        <span class="fw-bold letter-spacing-5">STAGE</span>
    </div>

    <div class="seat-grid mb-5">
        <div th:each="seat : ${seats}"
             th:id="'seat-' + ${seat.id}"
             th:classappend="${seat.getDisplayStatus() == 'AVAILABLE' ? '' :
                             (seat.getDisplayStatus() == 'OCCUPIED' ? 'sold' : 'sold')}"
             class="seat-item"
             th:text="${seat.seatNumber}"
             th:onclick="${seat.getDisplayStatus() == 'AVAILABLE'} ? 'occupySeat(' + ${seat.id} + ')' : ''">
        </div>
    </div>

    <div class="d-flex justify-content-center gap-4 mb-5">
        <div class="d-flex align-items-center">
            <div class="seat-item me-2" style="width: 24px; height: 24px; cursor: default;"></div>
            <small>선택 가능</small>
        </div>
        <div class="d-flex align-items-center">
            <div class="seat-item sold me-2" style="width: 24px; height: 24px; cursor: default;"></div>
            <small>선택 불가</small>
        </div>
        <div class="d-flex align-items-center">
            <div class="seat-item selected me-2" style="width: 24px; height: 24px; cursor: default; background-color: #3b82f6; border-color: #3b82f6; color: white;"></div>
            <small>선택 중</small>
        </div>
    </div>

</div>

<div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3">
    <div id="liveToast" class="toast align-items-center text-white bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-body">
                메시지 내용
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const userId = [[${userId}]];
    const concertId = [[${concertId}]];
    const toastEl = document.getElementById('liveToast');
    const toast = new bootstrap.Toast(toastEl);

    // 에러 파라미터 체크
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('error') === 'taken') showToast("⚠️ 이미 선점된 좌석입니다.");
    if (urlParams.get('error') === 'timeout') showToast("⏰ 결제 시간이 만료되었습니다.");

    function occupySeat(seatId) {
        const btn = document.getElementById('seat-' + seatId);

        // 시각적 피드백 (파란색으로 변경)
        btn.classList.add('selected');

        fetch(`/api/seats/${seatId}/occupy?userId=${userId}`, { method: 'POST' })
        .then(res => {
            if (res.ok) {
                // 성공 -> 결제 페이지 이동
                window.location.href = `/concerts/${concertId}/payments?seatId=${seatId}&userId=${userId}`;
            } else if (res.status === 409) {
                // 실패 -> 빨간색 처리
                showToast("⚠️ 다른 사용자가 방금 선택했습니다.");
                btn.classList.remove('selected');
                btn.classList.add('sold');
                btn.onclick = null; // 클릭 이벤트 제거
            } else {
                showToast("서버 오류가 발생했습니다.");
                btn.classList.remove('selected');
            }
        })
        .catch(err => {
            console.error(err);
            btn.classList.remove('selected');
        });
    }

    function showToast(msg) {
        document.getElementById('toast-body').innerText = msg;
        toast.show();
    }
</script>
</body>
</html>