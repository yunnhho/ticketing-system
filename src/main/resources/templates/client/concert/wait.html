<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="client/fragment/header :: header"></head>

<body>
<div class="container d-flex justify-content-center align-items-center min-vh-100">

    <div id="captcha-container" class="card shadow-lg border-0 p-4" style="max-width: 450px; width: 100%;">
        <div class="card-body text-center">
            <h3 class="fw-bold mb-3">🔒 보안 확인</h3>
            <p class="text-muted mb-4">비정상적인 접근을 막기 위해<br>아래 문자를 입력해주세요.</p>

            <div id="captcha-display" class="bg-light border rounded py-3 mb-3 fw-bold letter-spacing-5 fs-2 text-primary">
                LOADING...
            </div>

            <div class="input-group mb-3">
                <input type="text" id="captcha-input" class="form-control form-control-lg text-center" placeholder="보안 문자 입력">
                <button class="btn btn-primary btn-lg" onclick="enterQueue()">입장</button>
            </div>
            <div class="d-grid">
                <button class="btn btn-sm btn-link text-decoration-none text-secondary" onclick="location.reload()">새로고침</button>
            </div>
        </div>
    </div>

    <div id="queue-container" class="card shadow-lg border-0 p-5 d-none" style="max-width: 500px; width: 100%;">
        <div class="card-body text-center">
            <h2 class="fw-bold mb-4">접속 대기 중...</h2>

            <div class="spinner-border text-primary mb-4" role="status" style="width: 4rem; height: 4rem;"></div>

            <p class="text-muted mb-1">현재 내 앞의 대기 인원</p>
            <h1 id="rankText" class="display-3 fw-bold text-primary mb-4">0</h1>

            <div class="bg-light rounded p-3 mb-3">
                <p class="mb-1 small text-muted">예상 대기 시간</p>
                <strong id="timeText" class="fs-4 text-dark">계산 중...</strong>
            </div>

            <div class="alert alert-warning d-flex align-items-center small text-start" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>
                    새로고침 하거나 창을 닫으면<br>대기 순번이 초기화될 수 있습니다.
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    const concertId = [[${concertId}]];
    const userId = [[${userId}]];
    let stompClient = null;

    // 1. 페이지 로드 시 캡차 불러오기
    window.onload = function() {
        fetch('/api/queue/captcha')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('captcha-display').innerText = data.data.captcha;
                } else {
                    alert("캡차 로드 실패");
                }
            })
            .catch(err => {
                console.error("API 호출 에러:", err);
                document.getElementById('captcha-display').innerText = "ERROR";
            });
    };

    // 2. 캡차 입력 후 대기열 진입
    function enterQueue() {
        const input = document.getElementById('captcha-input').value;

        if (!input) {
            alert("보안 문자를 입력해주세요.");
            return;
        }

        const formData = new URLSearchParams();
        formData.append('concertId', concertId);
        formData.append('userId', userId);
        formData.append('captchaInput', input);

        fetch('/api/queue/token', {
            method: 'POST',
            body: formData
        })
        .then(async res => {
            if (res.ok) {
                document.getElementById('captcha-container').classList.add('d-none');
                document.getElementById('queue-container').classList.remove('d-none');

                // 라이브러리가 로드된 후 실행되므로 안전함
                connectWebSocket();
                startPolling();
            } else {
                alert(await res.text());
                document.getElementById('captcha-input').value = '';
                window.onload(); // 캡차 새로고침
            }
        })
        .catch(err => console.error(err));
    }

    // 3. 웹소켓 연결
    function connectWebSocket() {
        // SockJS가 이제 정의되어 있으므로 에러가 나지 않습니다.
        const socket = new SockJS('/ws-queue');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            console.log('WS Connected');

            stompClient.subscribe('/topic/queue/' + userId, function (message) {
                const data = JSON.parse(message.body);
                if (data.pass) {
                    goToSeats();
                }
            });
        }, function(error) {
            console.error("WS Error:", error);
        });
    }

    // 4. 상태 폴링
    function startPolling() {
        let isPassed = false;
        const intervalId = setInterval(() => {
            if(isPassed) {
                clearInterval(intervalId);
                return;
            }

            fetch(`/api/queue/status?concertId=${concertId}&userId=${userId}`)
                .then(res => res.json())
                .then(response => {
                    const data = response.data;
                    if (data.pass) {
                        isPassed = true;
                        goToSeats();
                    } else {
                        document.getElementById('rankText').innerText = data.rank;
                        const min = Math.floor(data.estimatedSeconds / 60);
                        const sec = data.estimatedSeconds % 60;
                        document.getElementById('timeText').innerText =
                            (min > 0 ? min + "분 " : "") + sec + "초";
                    }
                })
                .catch(err => console.error(err));
        }, 3000);
    }

    function goToSeats() {
        window.location.href = `/concerts/${concertId}/seats?userId=${userId}`;
    }
</script>
</body>
</html>